name: PROD Database Migrations

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  AWS_REGION: "eu-west-1"
  ENV: "prod"

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }} 
      all_changed_files: ${{ steps.changed-files.outputs.all_changed_files }}
      migrations_path:  ${{ steps.extract-path.outputs.migrations_path }} 
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed application files
      id: changed-files
      uses: tj-actions/changed-files@v47
      with:
        files: |
          */*/migrations/**
        matrix: true
        since_last_remote_commit: true

    - name: Extract migrations root
      id: extract-path
      env:
        ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        ANY_CHANGED_FILES: ${{ steps.changed-files.outputs.any_changed }} 
      run: |
        echo "Raw changed ALL files output: '$ALL_CHANGED_FILES'"
        echo "Raw changed ANY files output: '$ANY_CHANGED_FILES'"
        MIGRATIONS_PATH=$(echo "$ALL_CHANGED_FILES" \
          | tr -d '[]"' \
          | tr ',' '\n' \
          | sed 's|/migrations/.*||' \
          | sort -u)
        echo $MIGRATIONS_PATH
        echo "migrations_path=$MIGRATIONS_PATH" >> $GITHUB_OUTPUT


  parse_config:
    runs-on: ubuntu-latest
    needs: detect_changes
    if: needs.detect_changes.outputs.any_changed == 'true' && needs.detect_changes.outputs.migrations_path != ''
    outputs:
      db_name: ${{ steps.config.outputs.db_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Install yq
        run: |
          sudo curl -L -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Parse Config file
        id: config    
        env:
          MIGRATIONS_PATH: ${{ needs.detect_changes.outputs.migrations_path }}
        run: |
          CONFIG_FILE="$MIGRATIONS_PATH/database-config.yaml"
          DB_NAME=$(yq '.database.name' "$CONFIG_FILE")
          echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT


  output_name:
    runs-on: ubuntu-latest
    needs: [detect_changes, parse_config]
    
    steps:
      - name: output
        run: |
          {
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ³ ${{ needs.parse_config.outputs.db_name }} ðŸ³"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"        
          } >> "$GITHUB_STEP_SUMMARY"